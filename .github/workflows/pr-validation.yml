name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-pr:
    name: Validate PR Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.1.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Validate PR title format
      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check for conventional commit format
          if [[ ! $PR_TITLE =~ ^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z0-9-]+\))?!:\ .+ ]]; then
            echo "‚ùå PR title does not follow conventional commit format"
            echo "Expected: type(scope): description"
            echo "Examples:"
            echo "  feat: add user authentication"
            echo "  fix(ui): resolve login button styling"
            echo "  docs: update API documentation"
            exit 1
          fi

          echo "‚úÖ PR title format is valid"

      # Validate PR body contains issue reference
      - name: Validate PR body
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          # Check for issue references
          if [[ ! $PR_BODY =~ (closes|fixes|resolves)\s+#[0-9]+ ]]; then
            echo "‚ùå PR body must contain issue reference (closes #123, fixes #456, etc.)"
            echo "Add one of the following to your PR description:"
            echo "  Closes #123"
            echo "  Fixes #456"
            echo "  Resolves #789"
            exit 1
          fi

          echo "‚úÖ PR contains valid issue reference"

      # Validate PR has tests
      - name: Validate test files
        run: |
          # Get changed files in PR
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')

          # Check for test files
          TEST_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(test|spec)\.(ts|tsx|js|jsx)$' || true)

          if [[ -z "$TEST_FILES" ]]; then
            echo "‚ö†Ô∏è  No test files found in PR changes"
            echo "Consider adding tests for your changes to maintain code quality"
            # Don't fail for now, but warn
          else
            echo "‚úÖ PR contains test files:"
            echo "$TEST_FILES"
          fi

      # Check code changes volume
      - name: Validate code changes
        run: |
          # Get PR stats
          ADDITIONS=$(gh pr view ${{ github.event.pull_request.number }} --json additions --jq '.additions')
          DELETIONS=$(gh pr view ${{ github.event.pull_request.number }} --json deletions --jq '.deletions')
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json changedFiles --jq '.changedFiles')

          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))

          echo "PR Statistics:"
          echo "  Files changed: $CHANGED_FILES"
          echo "  Additions: $ADDITIONS"
          echo "  Deletions: $DELETIONS"
          echo "  Total changes: $TOTAL_CHANGES"

          # SWE-Bench minimum: 10+ lines of meaningful code changes
          if [[ $TOTAL_CHANGES -lt 10 ]]; then
            echo "‚ö†Ô∏è  PR has less than 10 lines of changes ($TOTAL_CHANGES)"
            echo "SWE-Bench requires meaningful code changes"
            # Don't fail for small changes, but warn
          else
            echo "‚úÖ PR meets minimum code change requirements"
          fi

  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.1.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Validate all commits in PR
      - name: Validate commits
        run: |
          # Get commits in this PR
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].messageHeadline')

          echo "Validating commits in PR:"
          FAILED_COMMITS=0

          while IFS= read -r commit_msg; do
            if [[ -n "$commit_msg" ]]; then
              echo "Checking: $commit_msg"

              # Check conventional commit format
              if [[ ! $commit_msg =~ ^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z0-9-]+\))?!:\ .+ ]]; then
                echo "‚ùå Invalid commit format: $commit_msg"
                FAILED_COMMITS=$((FAILED_COMMITS + 1))
              else
                echo "‚úÖ Valid format: $commit_msg"
              fi
            fi
          done <<< "$COMMITS"

          if [[ $FAILED_COMMITS -gt 0 ]]; then
            echo "‚ùå $FAILED_COMMITS commit(s) do not follow conventional format"
            exit 1
          fi

          echo "‚úÖ All commits follow conventional format"

  f2p-validation:
    name: F2P/P2P Test Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate F2P/P2P mentions
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          # Check for F2P tests
          if [[ ! $PR_BODY =~ "F2P Tests" ]] || [[ ! $PR_BODY =~ "P2P Tests" ]]; then
            echo "‚ö†Ô∏è  PR should mention F2P and P2P tests for SWE-Bench compliance"
            echo "Add sections like:"
            echo "## F2P/P2P Tests"
            echo "- F2P: [describe what fails before, passes after]"
            echo "- P2P: [describe regression protection]"
            # Don't fail, just warn for now
          else
            echo "‚úÖ PR mentions F2P and P2P tests"
          fi

  comment-validation-results:
    name: Comment Validation Results
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-pr, validate-commits, f2p-validation]

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number
            const results = {
              pr: '${{ needs.validate-pr.result }}',
              commits: '${{ needs.validate-commits.result }}',
              f2p: '${{ needs.f2p-validation.result }}'
            }

            let comment = '## üîç PR Validation Results\n\n'

            if (results.pr === 'success') {
              comment += '‚úÖ **PR format validation**: Passed\n'
            } else {
              comment += '‚ùå **PR format validation**: Failed\n'
            }

            if (results.commits === 'success') {
              comment += '‚úÖ **Commit message validation**: Passed\n'
            } else {
              comment += '‚ùå **Commit message validation**: Failed\n'
            }

            if (results.f2p === 'success') {
              comment += '‚úÖ **F2P/P2P validation**: Passed\n'
            } else {
              comment += '‚ö†Ô∏è  **F2P/P2P validation**: Warning\n'
            }

            comment += '\n### SWE-Bench Compliance Checklist\n'
            comment += '- [x] Conventional commit format\n'
            comment += '- [x] Issue reference in PR\n'
            comment += '- [ ] Test files included\n'
            comment += '- [ ] 10+ lines of code changes\n'
            comment += '- [ ] F2P tests documented\n'
            comment += '- [ ] P2P tests documented\n'

            if (results.pr === 'success' && results.commits === 'success') {
              comment += '\nüéâ **Ready for SWE-Bench evaluation!**'
            } else {
              comment += '\n‚ö†Ô∏è  **Please address validation failures before merge.**'
            }

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })